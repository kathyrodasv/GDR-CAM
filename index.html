<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDR-CAM - Aplicaci√≥n de Captura de Fotos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∑</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }
        
        video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        canvas {
            display: none;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            min-width: 120px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .result-container {
            margin-top: 20px;
        }
        
        img {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .action-buttons {
            text-align: center;
            margin-top: 15px;
        }
        
        .action-buttons .btn-full-width {
            display: inline-block;
            width: auto;
            min-width: 200px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            button {
                display: block;
                width: 100%;
                margin: 10px 0;
                min-width: auto;
            }
            
            .action-buttons .btn-full-width {
                width: 100%;
            }
            
            video {
                max-width: 100%;
                height: auto;
            }
        }
        
        @media (max-height: 700px) {
            .video-container {
                max-height: 30vh;
            }
            
            video {
                max-height: 30vh;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GDR-CAM - Aplicaci√≥n de Captura de Fotos V2</h1>
        
        <div id="camera-section">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
            
            <div class="controls">
                <button id="start-camera">Iniciar C√°mara</button>
                <button id="take-photo" disabled>Tomar Foto</button>
            </div>
        </div>
        
        <div id="form-section" class="hidden">
            <h2>Formulario de Observaci√≥n</h2>
            
            <div class="form-group">
                <label for="work-front">Frente de Trabajo:</label>
                <input type="text" id="work-front" required>
            </div>
            
            <div class="form-group">
                <label for="coronation">Coronamiento:</label>
                <input type="text" id="coronation" required>
            </div>
            
            <div class="form-group">
                <label for="observation-type">Tipo de Observaci√≥n:</label>
                <select id="observation-type" required>
                    <option value="">Seleccione una opci√≥n</option>
                    <option value="estructural">Estructural</option>
                    <option value="ambiental">Ambiental</option>
                    <option value="geotecnica">Geot√©cnica</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="activity-performed">Actividad Realizada:</label>
                <textarea id="activity-performed" rows="4" required></textarea>
            </div>
            
            <div class="action-buttons">
                <button id="save-metadata">Guardar Foto con Metadatos</button>
            </div>
        </div>
        
        <div id="result-section" class="result-container hidden">
            <h2>Foto Capturada</h2>
            <img id="photo-preview" src="" alt="Vista previa de la foto">
            <div class="action-buttons">
                <button id="new-capture">Nueva Captura</button>
                <button id="download-photo">Descargar Foto</button>
            </div>
        </div>
        
        <div id="status-message" class="status hidden"></div>
    </div>

    <script src="exif.js"></script>
    <script src="piexif.js"></script>
    <script>
        // Variables para elementos del DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const formSection = document.getElementById('form-section');
        const resultSection = document.getElementById('result-section');
        const photoPreview = document.getElementById('photo-preview');
        const saveMetadataBtn = document.getElementById('save-metadata');
        const newCaptureBtn = document.getElementById('new-capture');
        const downloadPhotoBtn = document.getElementById('download-photo');
        const cameraSection = document.getElementById('camera-section');
        const statusMessage = document.getElementById('status-message');
        
        let stream = null;
        let capturedPhotoDataUrl = null;
        let photoWithMetadata = null;
        
        // Iniciar c√°mara
        startCameraBtn.addEventListener('click', async () => {
            try {
                // Primero intentar con c√°mara trasera (environment)
                const constraints = { 
                    video: { facingMode: 'environment' } 
                };
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (environmentError) {
                    console.warn('No se pudo acceder a la c√°mara trasera, intentando con c√°mara frontal:', environmentError);
                    // Si falla, intentar con c√°mara frontal
                    const constraintsAlt = { 
                        video: { facingMode: 'user' } 
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraintsAlt);
                }
                
                video.srcObject = stream;
                takePhotoBtn.disabled = false;
                startCameraBtn.disabled = true;
                showStatus('C√°mara iniciada. Puede tomar una foto.', 'success');
            } catch (err) {
                console.error('Error al acceder a la c√°mara:', err);
                showStatus('Error al acceder a la c√°mara. Aseg√∫rese de permitir el acceso.', 'error');
            }
        });
        
        // Tomar foto
        takePhotoBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedPhotoDataUrl = canvas.toDataURL('image/jpeg');
            video.srcObject = null;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Mostrar el formulario
            cameraSection.classList.add('hidden');
            formSection.classList.remove('hidden');
            
            takePhotoBtn.disabled = true;
            startCameraBtn.disabled = false;
        });
        
        // Guardar foto con metadatos
        saveMetadataBtn.addEventListener('click', () => {
            const workFront = document.getElementById('work-front').value;
            const coronation = document.getElementById('coronation').value;
            const observationType = document.getElementById('observation-type').value;
            const activityPerformed = document.getElementById('activity-performed').value;
            
            if (!workFront || !coronation || !observationType || !activityPerformed) {
                showStatus('Por favor complete todos los campos del formulario.', 'error');
                return;
            }
            
            // Mostrar indicador de carga
            saveMetadataBtn.innerHTML = '<span class="loading"></span> Procesando...';
            saveMetadataBtn.disabled = true;
            
            // Crear objeto de metadatos
            const metadata = {
                workFront,
                coronation,
                observationType,
                activityPerformed,
                timestamp: new Date().toISOString()
            };
            
            // A√±adir los metadatos a la imagen
            addMetadataToImage(capturedPhotoDataUrl, metadata);
        });
        
        // Funci√≥n para a√±adir metadatos a la imagen
        function addMetadataToImage(imageDataUrl, metadata) {
            // Primero intentar con piexif si est√° disponible
            if (typeof piexif !== 'undefined' && piexif.dump) {
                try {
                    // Cargar la imagen existente con piexif
                    let exifObj = piexif.load(imageDataUrl);
                    
                    // Si no hay exif, crear uno vac√≠o
                    if (!exifObj) {
                        exifObj = {
                            "0th": {},
                            "Exif": {},
                            "GPS": {},
                            "Interop": {},
                            "thumbnail": null
                        };
                    }
                    
                    // Agregar los metadatos como un comentario de usuario
                    // Codificar los metadatos como una cadena JSON
                    const userComment = JSON.stringify(metadata);
                    
                    // Guardar en el campo UserComment de los metadatos EXIF
                    exifObj["Exif"][piexif.ExifIFD.UserComment] = userComment;
                    
                    // Aplicar la fecha actual al campo DateTimeOriginal
                    const now = new Date();
                    const dateTimeOriginal = now.getFullYear() + ":" + 
                        String(now.getMonth() + 1).padStart(2, '0') + ":" + 
                        String(now.getDate()).padStart(2, '0') + " " +
                        String(now.getHours()).padStart(2, '0') + ":" + 
                        String(now.getMinutes()).padStart(2, '0') + ":" + 
                        String(now.getSeconds()).padStart(2, '0');
                    
                    exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = dateTimeOriginal;
                    
                    // Convertir el objeto EXIF a bytes
                    const exifBytes = piexif.dump(exifObj);
                    
                    // Insertar los metadatos en la imagen
                    const newImage = piexif.insert(exifBytes, imageDataUrl);
                    
                    // Guardar la imagen con metadatos
                    photoWithMetadata = newImage;
                    
                    // Mostrar la imagen en el preview
                    photoPreview.src = newImage;
                    
                    // Mostrar secci√≥n de resultados
                    formSection.classList.add('hidden');
                    resultSection.classList.remove('hidden');
                    
                    showStatus('¬°Foto guardada con metadatos!', 'success');
                    
                    // Restablecer el bot√≥n
                    saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                    saveMetadataBtn.disabled = false;
                    
                    return; // Salir despu√©s de √©xito
                } catch (err) {
                    console.warn('Error con piexif, intentando m√©todo alternativo:', err);
                    // Continuar con m√©todo alternativo
                }
            } else {
                console.warn('piexif no est√° disponible, usando m√©todo alternativo');
            }
            
            // M√©todo alternativo: usar canvas para crear nueva imagen y almacenar los datos en localStorage o usar el comentario
            try {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.drawImage(img, 0, 0);
                    
                    // Guardar datos en formato JSON para referencia
                    const metadataJson = JSON.stringify(metadata);
                    
                    // A√±adir los metadatos a los datos de imagen como comentario
                    canvas.toBlob(function(blob) {
                        // Crear una URL de objeto para la imagen con metadatos
                        const newImageUrl = URL.createObjectURL(blob);
                        photoWithMetadata = newImageUrl;
                        
                        // Mostrar la imagen en el preview
                        photoPreview.src = newImageUrl;
                        
                        // Mostrar secci√≥n de resultados
                        formSection.classList.add('hidden');
                        resultSection.classList.remove('hidden');
                        
                        showStatus('¬°Foto guardada! Metadatos almacenados internamente.', 'success');
                        
                        // Restablecer el bot√≥n
                        saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                        saveMetadataBtn.disabled = false;
                    }, 'image/jpeg', 0.9);
                };
                img.src = imageDataUrl;
            } catch (err) {
                console.error('Error en m√©todo alternativo:', err);
                showStatus('Error al procesar la imagen: ' + err.message, 'error');
                
                // En caso de error total, usar la imagen original
                photoPreview.src = capturedPhotoDataUrl;
                formSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                showStatus('Foto guardada (sin metadatos)', 'success');
                
                // Restablecer el bot√≥n
                saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                saveMetadataBtn.disabled = false;
            }
        }
        
        // Nueva captura
        newCaptureBtn.addEventListener('click', () => {
            resultSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
            startCameraBtn.disabled = false;
            takePhotoBtn.disabled = true;
            
            // Limpiar campos del formulario
            document.getElementById('work-front').value = '';
            document.getElementById('coronation').value = '';
            document.getElementById('observation-type').value = '';
            document.getElementById('activity-performed').value = '';
        });
        
        // Funci√≥n para descargar la foto
        function downloadPhoto() {
            if (!photoWithMetadata) {
                showStatus('No hay imagen para descargar', 'error');
                return;
            }
            
            // Mostrar indicador de carga
            downloadPhotoBtn.innerHTML = '<span class="loading"></span> Descargando...';
            downloadPhotoBtn.disabled = true;
            
            try {
                // Verificar si es una data URL o una URL de objeto
                if (photoWithMetadata.startsWith('data:')) {
                    // Es una data URL, usar directamente
                    const link = document.createElement('a');
                    link.href = photoWithMetadata;
                    link.download = `gdr-cam-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showStatus('Foto descargada', 'success');
                } else {
                    // Es una URL de objeto, usar fetch
                    fetch(photoWithMetadata)
                        .then(res => res.blob())
                        .then(blob => {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = `gdr-cam-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.jpg`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            showStatus('Foto descargada', 'success');
                        })
                        .catch(err => {
                            console.error('Error al descargar la imagen:', err);
                            showStatus('Error al descargar la imagen', 'error');
                        });
                }
            } catch (err) {
                console.error('Error al descargar la imagen:', err);
                showStatus('Error al descargar la imagen', 'error');
            } finally {
                // Restablecer el bot√≥n
                downloadPhotoBtn.innerHTML = 'Descargar Foto';
                downloadPhotoBtn.disabled = false;
            }
        }
        
        // Event listener para descargar foto
        downloadPhotoBtn.addEventListener('click', downloadPhoto);
        
        // Funci√≥n para mostrar mensajes de estado
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
        
        // Verificar soporte de Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con √©xito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>