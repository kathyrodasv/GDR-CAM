<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDR-CAM - Aplicaci√≥n de Captura de Fotos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∑</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }
        
        video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        canvas {
            display: none;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .result-container {
            margin-top: 20px;
        }
        
        img {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .action-buttons {
            text-align: center;
            margin-top: 15px;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            button {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GDR-CAM - Aplicaci√≥n de Captura de Fotos</h1>
        
        <div id="camera-section">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
            
            <div class="controls">
                <button id="start-camera">Iniciar C√°mara</button>
                <button id="take-photo" disabled>Tomar Foto</button>
            </div>
        </div>
        
        <div id="form-section" class="hidden">
            <h2>Formulario de Observaci√≥n</h2>
            
            <div class="form-group">
                <label for="work-front">Frente de Trabajo:</label>
                <input type="text" id="work-front" required>
            </div>
            
            <div class="form-group">
                <label for="coronation">Coronamiento:</label>
                <input type="text" id="coronation" required>
            </div>
            
            <div class="form-group">
                <label for="observation-type">Tipo de Observaci√≥n:</label>
                <select id="observation-type" required>
                    <option value="">Seleccione una opci√≥n</option>
                    <option value="estructural">Estructural</option>
                    <option value="ambiental">Ambiental</option>
                    <option value="geotecnica">Geot√©cnica</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="activity-performed">Actividad Realizada:</label>
                <textarea id="activity-performed" rows="4" required></textarea>
            </div>
            
            <div class="action-buttons">
                <button id="save-metadata">Guardar Foto con Metadatos</button>
            </div>
        </div>
        
        <div id="result-section" class="result-container hidden">
            <h2>Foto Capturada</h2>
            <img id="photo-preview" src="" alt="Vista previa de la foto">
            <div class="action-buttons">
                <button id="new-capture">Nueva Captura</button>
                <button id="download-photo">Descargar Foto</button>
            </div>
        </div>
        
        <div id="status-message" class="status hidden"></div>
    </div>

    <script src="exif.js"></script>
    <script>
        // Variables para elementos del DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const formSection = document.getElementById('form-section');
        const resultSection = document.getElementById('result-section');
        const photoPreview = document.getElementById('photo-preview');
        const saveMetadataBtn = document.getElementById('save-metadata');
        const newCaptureBtn = document.getElementById('new-capture');
        const downloadPhotoBtn = document.getElementById('download-photo');
        const cameraSection = document.getElementById('camera-section');
        const statusMessage = document.getElementById('status-message');
        
        let stream = null;
        let capturedPhotoDataUrl = null;
        let photoWithMetadata = null;
        
        // Iniciar c√°mara
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Preferir c√°mara trasera si est√° disponible
                });
                
                video.srcObject = stream;
                takePhotoBtn.disabled = false;
                startCameraBtn.disabled = true;
                showStatus('C√°mara iniciada. Puede tomar una foto.', 'success');
            } catch (err) {
                console.error('Error al acceder a la c√°mara:', err);
                showStatus('Error al acceder a la c√°mara. Aseg√∫rese de permitir el acceso.', 'error');
            }
        });
        
        // Tomar foto
        takePhotoBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedPhotoDataUrl = canvas.toDataURL('image/jpeg');
            video.srcObject = null;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Mostrar el formulario
            cameraSection.classList.add('hidden');
            formSection.classList.remove('hidden');
            
            takePhotoBtn.disabled = true;
            startCameraBtn.disabled = false;
        });
        
        // Guardar foto con metadatos
        saveMetadataBtn.addEventListener('click', () => {
            const workFront = document.getElementById('work-front').value;
            const coronation = document.getElementById('coronation').value;
            const observationType = document.getElementById('observation-type').value;
            const activityPerformed = document.getElementById('activity-performed').value;
            
            if (!workFront || !coronation || !observationType || !activityPerformed) {
                showStatus('Por favor complete todos los campos del formulario.', 'error');
                return;
            }
            
            // Crear objeto de metadatos
            const metadata = {
                workFront,
                coronation,
                observationType,
                activityPerformed,
                timestamp: new Date().toISOString()
            };
            
            // A√±adir los metadatos como comentario de usuario en la imagen
            addMetadataToImage(capturedPhotoDataUrl, metadata);
        });
        
        // Funci√≥n para a√±adir metadatos a la imagen
        function addMetadataToImage(imageDataUrl, metadata) {
            // Convertir la imagen a blob
            fetch(imageDataUrl)
                .then(res => res.blob())
                .then(blob => {
                    // Usar EXIF.js para leer los metadatos existentes
                    EXIF.getData(blob, function() {
                        // Crear la imagen para manipularla
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            canvas.width = img.width;
                            canvas.height = img.height;
                            
                            ctx.drawImage(img, 0, 0);
                            
                            // Convertir los metadatos a string
                            const metadataString = JSON.stringify(metadata);
                            
                            // Crear un objeto ImageData para contener metadatos en el √∫ltimo p√≠xel
                            // Nota: Esto es una aproximaci√≥n simple. Para una soluci√≥n robusta,
                            // se deber√≠a usar una biblioteca‰∏ìÈó® para manipular EXIF
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // Almacenar los metadatos codificados en el √∫ltimo p√≠xel
                            const encodedMetadata = btoa(unescape(encodeURIComponent(metadataString)));
                            const pixelIndex = (imageData.width * imageData.height - 1) * 4;
                            if (pixelIndex + 3 < imageData.data.length) {
                                // Codificar la longitud del string
                                const length = encodedMetadata.length;
                                imageData.data[pixelIndex] = length & 0xFF; // R
                                imageData.data[pixelIndex + 1] = (length >> 8) & 0xFF; // G
                                imageData.data[pixelIndex + 2] = (length >> 16) & 0xFF; // B
                                imageData.data[pixelIndex + 3] = 255; // A (no transparent)
                                
                                // Actualizar la imagen con los datos
                                ctx.putImageData(imageData, 0, 0);
                                
                                // Convertir de nuevo a blob
                                canvas.toBlob(function(blobWithMetadata) {
                                    // Convertir blob a URL para previsualizar
                                    const newImageUrl = URL.createObjectURL(blobWithMetadata);
                                    photoWithMetadata = newImageUrl;
                                    
                                    // Mostrar la imagen en el preview
                                    photoPreview.src = newImageUrl;
                                    
                                    // Mostrar secci√≥n de resultados
                                    formSection.classList.add('hidden');
                                    resultSection.classList.remove('hidden');
                                    
                                    showStatus('¬°Foto guardada con metadatos!', 'success');
                                }, 'image/jpeg', 0.9);
                            } else {
                                // Si no hay suficiente espacio, simplemente usar la imagen original
                                photoPreview.src = imageDataUrl;
                                formSection.classList.add('hidden');
                                resultSection.classList.remove('hidden');
                                showStatus('Foto guardada (metadatos no incluidos)', 'success');
                            }
                        };
                        img.src = imageDataUrl;
                    });
                })
                .catch(err => {
                    console.error('Error al procesar la imagen:', err);
                    showStatus('Error al procesar la imagen.', 'error');
                });
        }
        
        // Extraer metadatos de la imagen (funcionalidad adicional)
        function extractMetadataFromImage(imageUrl) {
            // Esta funci√≥n extraer√≠a los metadatos de la imagen si estuvieran almacenados
            // en el formato que usamos para insertarlos
            console.log('Extrayendo metadatos de:', imageUrl);
        }
        
        // Nueva captura
        newCaptureBtn.addEventListener('click', () => {
            resultSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
            startCameraBtn.disabled = false;
            takePhotoBtn.disabled = true;
            
            // Limpiar campos del formulario
            document.getElementById('work-front').value = '';
            document.getElementById('coronation').value = '';
            document.getElementById('observation-type').value = '';
            document.getElementById('activity-performed').value = '';
        });
        
        // Descargar foto
        downloadPhotoBtn.addEventListener('click', () => {
            if (photoWithMetadata) {
                const link = document.createElement('a');
                link.href = photoWithMetadata;
                link.download = `gdr-cam-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('Foto con metadatos descargada', 'success');
            } else {
                showStatus('No hay imagen para descargar', 'error');
            }
        });
        
        // Funci√≥n para mostrar mensajes de estado
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
        
        // Verificar soporte de Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con √©xito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>