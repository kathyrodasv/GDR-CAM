<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDR-CAM - Aplicaci칩n de Captura de Fotos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游닝</text></svg>">
</head>
<body>
    <div class="container">
        <h1>GDR-CAM - Aplicaci칩n de Captura de Fotos V11</h1>
        
        <div id="camera-section">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
            
            <div class="controls">
                <button id="start-camera">游닞 Iniciar C치mara</button>
                <button id="take-photo" disabled>游닝 Tomar Foto</button>
            </div>
        </div>
        
        <div id="form-section" class="hidden">
            <h2>Formulario de Observaci칩n</h2>
            
            <div class="form-group">
                <label for="work-front">Frente de Trabajo:</label>
                <input type="text" id="work-front" required>
            </div>
            
            <div class="form-group">
                <label for="coronation">Coronamiento:</label>
                <input type="text" id="coronation" required>
            </div>
            

            
            <div class="form-group">
                <label for="observation-category">Categor칤a de Observaci칩n:</label>
                <select id="observation-category" required>
                    <option value="">Seleccione una opci칩n</option>
                    <option value="rutina">Rutina</option>
                    <option value="liberacion">Liberaci칩n</option>
                    <option value="novedad">Novedad</option>
                    <option value="importante">Importante</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="activity-performed">Actividad Realizada:</label>
                <textarea id="activity-performed" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="gps-coords">Coordenadas GPS:</label>
                <input type="text" id="gps-coords" disabled>
            </div>
            
            <div class="action-buttons">
                <button id="save-metadata">Guardar Foto con Metadatos</button>
                <button id="save-photo-without-form">Guardar Foto sin Formulario</button>
            </div>
        </div>
        
        <div id="result-section" class="result-container hidden">
            <h2>Foto Capturada</h2>
            <img id="photo-preview" src="" alt="Vista previa de la foto">
            <div class="action-buttons">
                <button id="new-capture">Nueva Captura</button>
                <button id="download-photo">Guardar en Galer칤a</button>
                <button id="view-metadata">Ver Metadatos</button>
            </div>
        </div>
        
        <div id="status-message" class="status hidden"></div>
    </div>

    <div id="metadata-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Metadatos de la Imagen</h2>
            <pre id="metadata-display"></pre>
        </div>
    </div>

    <script src="exif.js"></script>
    <script src="piexif.js"></script>
    <script src="save-image.js"></script>
    <script>
        // Variables para elementos del DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const formSection = document.getElementById('form-section');
        const resultSection = document.getElementById('result-section');
        const photoPreview = document.getElementById('photo-preview');
        const saveMetadataBtn = document.getElementById('save-metadata');
        const newCaptureBtn = document.getElementById('new-capture');
        const downloadPhotoBtn = document.getElementById('download-photo');
        const cameraSection = document.getElementById('camera-section');
        const statusMessage = document.getElementById('status-message');
        
        let stream = null;
        let imageCapture = null;
        let capturedPhotoDataUrl = null;
        let photoWithMetadata = null;
        let currentLocation = null;
        
        // Iniciar c치mara
        startCameraBtn.addEventListener('click', async () => {
            try {
                // Primero intentar con c치mara trasera (environment)
                const constraints = { 
                    video: { facingMode: 'environment' } 
                };
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (environmentError) {
                    console.warn('No se pudo acceder a la c치mara trasera, intentando con c치mara frontal:', environmentError);
                    // Si falla, intentar con c치mara frontal
                    const constraintsAlt = { 
                        video: { facingMode: 'user' } 
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraintsAlt);
                }
                
                video.srcObject = stream;
                const track = stream.getVideoTracks()[0];
                if (typeof ImageCapture !== 'undefined'){
                    imageCapture = new ImageCapture(track);
                }
                
                takePhotoBtn.disabled = true; // Disable until location is obtained
                startCameraBtn.disabled = true;
                showStatus('C치mara iniciada. Obteniendo ubicaci칩n...', 'success');
                
                // Intentar obtener la ubicaci칩n
                getCurrentLocation();
            } catch (err) {
                console.error('Error al acceder a la c치mara:', err);
                showStatus('Error al acceder a la c치mara. Aseg칰rese de permitir el acceso.', 'error');
            }
        });
        
        // Intentar obtener la ubicaci칩n actual
        function getCurrentLocation() {
            const gpsDisplay = document.getElementById('gps-coords');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            timestamp: position.timestamp
                        };
                        console.log('Ubicaci칩n obtenida:', currentLocation);
                        showStatus('Ubicaci칩n obtenida. Puede tomar una foto.', 'success');
                        gpsDisplay.value = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                        takePhotoBtn.disabled = false; // Enable photo taking
                    },
                    (error) => {
                        console.warn('No se pudo obtener la ubicaci칩n:', error.message);
                        showStatus('No se pudo obtener la ubicaci칩n. Puede tomar la foto sin datos de GPS.', 'error');
                        gpsDisplay.value = 'No se pudo obtener la ubicaci칩n.';
                        takePhotoBtn.disabled = false; // Enable photo taking anyway
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                console.warn('Geolocalizaci칩n no soportada');
                showStatus('La geolocalizaci칩n no es compatible con este navegador', 'error');
                gpsDisplay.value = 'Geolocalizaci칩n no soportada.';
                takePhotoBtn.disabled = false; // Enable photo taking anyway
            }
        }
        
        // Tomar foto
        takePhotoBtn.addEventListener('click', () => {
            const processImage = (imageSource) => {
                const canvas = document.createElement('canvas');
                canvas.width = imageSource.videoWidth || imageSource.width;
                canvas.height = imageSource.videoHeight || imageSource.height;
                const context = canvas.getContext('2d');
                context.drawImage(imageSource, 0, 0, canvas.width, canvas.height);
                capturedPhotoDataUrl = canvas.toDataURL('image/jpeg', 0.95);

                video.srcObject = null;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                cameraSection.classList.add('hidden');
                formSection.classList.remove('hidden');
                takePhotoBtn.disabled = true;
                startCameraBtn.disabled = false;
            };

            if (imageCapture) {
                imageCapture.takePhoto()
                    .then(blob => {
                        const image = new Image();
                        image.src = URL.createObjectURL(blob);
                        image.onload = () => {
                            processImage(image);
                        };
                    })
                    .catch(error => {
                        console.error('Error taking photo:', error);
                        showStatus('Error al tomar la foto.', 'error');
                    });
            } else {
                processImage(video);
            }
        });
        
        // Guardar foto con metadatos
        saveMetadataBtn.addEventListener('click', () => {
            const workFront = document.getElementById('work-front').value;
            const coronation = document.getElementById('coronation').value;
            const activityPerformed = document.getElementById('activity-performed').value;
            const observationCategory = document.getElementById('observation-category').value;
            
            if (!workFront || !coronation || !activityPerformed || !observationCategory) {
                showStatus('Por favor complete todos los campos del formulario.', 'error');
                return;
            }
            
            // Crear objeto de metadatos
            const metadata = {
                workFront,
                coronation,
                activityPerformed,
                observationCategory,
                location: currentLocation,
                timestamp: new Date().toLocaleString() // Using local time format instead of ISO string
            };
            
            // Mostrar indicador de carga
            saveMetadataBtn.innerHTML = '<span class="loading"></span> Procesando...';
            saveMetadataBtn.disabled = true;
            
            // A침adir los metadatos a la imagen
            addMetadataToImage(capturedPhotoDataUrl, metadata);
        });
        
        // Guardar foto sin formulario (solo GPS y fecha/hora)
        document.getElementById('save-photo-without-form').addEventListener('click', () => {
            // Crear objeto de metadatos con solo GPS y fecha/hora
            const metadata = {
                location: currentLocation,
                timestamp: new Date().toLocaleString()
            };
            
            // Mostrar indicador de carga
            const saveWithoutFormBtn = document.getElementById('save-photo-without-form');
            saveWithoutFormBtn.innerHTML = '<span class="loading"></span> Procesando...';
            saveWithoutFormBtn.disabled = true;
            
            // A침adir los metadatos a la imagen
            addMetadataToImage(capturedPhotoDataUrl, metadata);
        });
        
        // Funci칩n para obtener la orientaci칩n actual del dispositivo
        function getOrientation() {
            let orientation = 1; // Valor por defecto (no rotado)
            
            // Usar screen.orientation si est치 disponible
            if (screen.orientation && screen.orientation.angle !== undefined) {
                const angle = screen.orientation.angle;
                switch(angle) {
                    case 90:
                        orientation = 6; // 90춿 clockwise
                        break;
                    case 180:
                        orientation = 3; // 180춿
                        break;
                    case 270:
                        orientation = 8; // 90춿 counterclockwise
                        break;
                    default:
                        orientation = 1; // 0춿
                }
            } 
            // Fallback para dispositivos que no soportan screen.orientation
            else if (window.orientation !== undefined) {
                switch(window.orientation) {
                    case 90:
                        orientation = 6; // 90춿 clockwise
                        break;
                    case -90:
                        orientation = 8; // 90춿 counterclockwise
                        break;
                    case 180:
                        orientation = 3; // 180춿
                        break;
                    default:
                        orientation = 1; // 0춿
                }
            }
            
            return orientation;
        }

        // Funci칩n para dibujar la fecha y hora y el logo en la imagen
        function drawTimestampAndLogoOnImage(imageDataUrl, timestamp) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    // Cargar el logo
                    const logo = new Image();
                    logo.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Dibujar la imagen original
                        ctx.drawImage(img, 0, 0);
                        
                        // Dibujar el logo en la esquina inferior izquierda
                        const logoPadding = 10; // Espacio desde los bordes
                        const logoHeight = 40; // Altura fija para el logo
                        const logoAspectRatio = logo.width / logo.height;
                        const logoWidth = logoHeight * logoAspectRatio;
                        
                        ctx.drawImage(logo, logoPadding, canvas.height - logoHeight - logoPadding, logoWidth, logoHeight);
                        
                        // Configurar estilo del texto
                        ctx.font = '16px Arial';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; // Blanco semi-transparente
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'bottom';
                        
                        // Dibujar la fecha y hora en la esquina inferior derecha
                        ctx.fillText(timestamp, canvas.width - 10, canvas.height - 10);
                        
                        // Agregar sombra para mejor visibilidad
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
                        ctx.shadowBlur = 3;
                        ctx.shadowOffsetX = 1;
                        ctx.shadowOffsetY = 1;
                        ctx.fillText(timestamp, canvas.width - 10, canvas.height - 10);
                        
                        // Restablecer la sombra
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 0;
                        
                        // Devolver la imagen con el texto y logo como data URL con mayor calidad
                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    };
                    logo.onerror = function() {
                        // Si no se puede cargar el logo, continuar solo con el timestamp
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Dibujar la imagen original
                        ctx.drawImage(img, 0, 0);
                        
                        // Configurar estilo del texto
                        ctx.font = '16px Arial';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; // Blanco semi-transparente
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'bottom';
                        
                        // Dibujar la fecha y hora en la esquina inferior derecha
                        ctx.fillText(timestamp, canvas.width - 10, canvas.height - 10);
                        
                        // Agregar sombra para mejor visibilidad
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
                        ctx.shadowBlur = 3;
                        ctx.shadowOffsetX = 1;
                        ctx.shadowOffsetY = 1;
                        ctx.fillText(timestamp, canvas.width - 10, canvas.height - 10);
                        
                        // Restablecer la sombra
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 0;
                        
                        // Devolver la imagen con el texto como data URL con mayor calidad
                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    };
                    logo.src = 'img/LOGO GDR.jpeg'; // Ruta al logo
                };
                img.onerror = function() {
                    reject(new Error('Error al cargar la imagen'));
                };
                img.src = imageDataUrl;
            });
        }

        // Funci칩n para a침adir metadatos a la imagen
        async function addMetadataToImage(imageDataUrl, metadata) {
            console.log("Iniciando addMetadataToImage");
            console.log("imageDataUrl (primeros 100 caracteres):", imageDataUrl.slice(0, 100));
            
            try {
                // Agregar la fecha y hora como texto en la imagen
                const timestampedImage = await drawTimestampAndLogoOnImage(imageDataUrl, metadata.timestamp);
                
                if (typeof piexif !== 'undefined' && piexif.dump) {
                    try {
                        console.log("Cargando EXIF data desde la imagen...");
                        let exifObj = piexif.load(timestampedImage);
                        console.log("EXIF data cargado:", JSON.parse(JSON.stringify(exifObj)));

                        if (!exifObj) {
                            console.log("No se encontr칩 EXIF data, creando objeto vac칤o.");
                            exifObj = {"0th": {}, "Exif": {}, "GPS": {}, "Interop": {}, "thumbnail": null};
                        }

                        console.log("Metadata a agregar:", metadata);
                        
                        // Only add UserComment if there's form data
                        if (metadata.workFront || metadata.coronation || metadata.activityPerformed || metadata.observationCategory) {
                            // Handle the encoding of the user comment
                            let userComment;
                            if (piexif.helper && piexif.helper.encodeToUnicode) {
                                userComment = piexif.helper.encodeToUnicode(JSON.stringify(metadata));
                            } else {
                                // Fallback: try to use the simpler ASCII encoding
                                // First, ensure metadata is properly stringified and encode safely
                                const metadataStr = JSON.stringify(metadata);
                                // Convert the string to a format that piexif can handle
                                userComment = "ASCII\0" + metadataStr;
                            }
                            
                            exifObj["Exif"][piexif.ExifIFD.UserComment] = userComment;
                            console.log("UserComment agregado al objeto EXIF.");
                        } else {
                            console.log("Sin datos de formulario, omitiendo UserComment.");
                        }

                        if (metadata.location) {
                            console.log("Agregando datos GPS...");
                            const lat = metadata.location.latitude;
                            const lng = metadata.location.longitude;
                            const latRef = lat >= 0 ? "N" : "S";
                            const lngRef = lng >= 0 ? "E" : "W";
                            const absLat = Math.abs(lat);
                            const absLng = Math.abs(lng);
                            
                            // Improve precision by using higher precision rational values
                            // Calculate degrees, minutes, and seconds with higher precision
                            const latDeg = Math.floor(absLat);
                            const latMinDecimal = (absLat - latDeg) * 60;
                            const latMin = Math.floor(latMinDecimal);
                            const latSec = (latMinDecimal - latMin) * 60;
                            
                            const lngDeg = Math.floor(absLng);
                            const lngMinDecimal = (absLng - lngDeg) * 60;
                            const lngMin = Math.floor(lngMinDecimal);
                            const lngSec = (lngMinDecimal - lngMin) * 60;

                            exifObj["GPS"] = {
                                [piexif.GPSIFD.GPSVersionID]: [2, 2, 0, 0],
                                [piexif.GPSIFD.GPSLatitudeRef]: latRef,
                                [piexif.GPSIFD.GPSLatitude]: [
                                    [latDeg, 1], 
                                    [latMin, 1], 
                                    [Math.round(latSec * 10000), 10000]  // Increased precision to 4 decimal places
                                ],
                                [piexif.GPSIFD.GPSLongitudeRef]: lngRef,
                                [piexif.GPSIFD.GPSLongitude]: [
                                    [lngDeg, 1], 
                                    [lngMin, 1], 
                                    [Math.round(lngSec * 10000), 10000]  // Increased precision to 4 decimal places
                                ]
                            };

                            if (metadata.location.altitude !== null && metadata.location.altitude !== undefined) {
                                const alt = Math.abs(metadata.location.altitude);
                                const altRef = metadata.location.altitude >= 0 ? 0 : 1;
                                exifObj["GPS"][piexif.GPSIFD.GPSAltitudeRef] = altRef;
                                exifObj["GPS"][piexif.GPSIFD.GPSAltitude] = [Math.round(alt * 10000), 10000]; // Increased precision
                            }
                            console.log("Datos GPS agregados:", exifObj["GPS"]);
                        }

                        const now = new Date();
                        const dateTimeOriginal = now.getFullYear() + ":" + 
                            String(now.getMonth() + 1).padStart(2, '0') + ":" + 
                            String(now.getDate()).padStart(2, '0') + " " +
                            String(now.getHours()).padStart(2, '0') + ":" + 
                            String(now.getMinutes()).padStart(2, '0') + ":" + 
                            String(now.getSeconds()).padStart(2, '0');
                        exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = dateTimeOriginal;
                        exifObj["0th"][piexif.ImageIFD.DateTime] = dateTimeOriginal;
                        
                        // Agregar informaci칩n de orientaci칩n
                        const orientation = getOrientation();
                        exifObj["0th"][piexif.ImageIFD.Orientation] = orientation;
                        console.log("Objeto EXIF final antes de 'dump':", JSON.parse(JSON.stringify(exifObj)));

                        const exifBytes = piexif.dump(exifObj);
                        console.log("EXIF data convertido a bytes.");

                        const newImage = piexif.insert(exifBytes, timestampedImage);
                        console.log("Nueva imagen creada con EXIF data insertado.");

                        photoWithMetadata = newImage;
                        photoPreview.src = newImage;
                        formSection.classList.add('hidden');
                        resultSection.classList.remove('hidden');
                        showStatus('춰Foto guardada con metadatos!', 'success');
                        // Reset both buttons if they exist
                        if (saveMetadataBtn) {
                            saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                            saveMetadataBtn.disabled = false;
                        }
                        const saveWithoutFormBtn = document.getElementById('save-photo-without-form');
                        if (saveWithoutFormBtn) {
                            saveWithoutFormBtn.innerHTML = 'Guardar Foto sin Formulario';
                            saveWithoutFormBtn.disabled = false;
                        }
                        
                        // Automatically save to gallery
                        saveToGallery(newImage);

                    } catch (err) {
                        console.error('Error en addMetadataToImage:', err);
                        showStatus('Error al guardar los metadatos.', 'error');
                        // Reset both buttons if they exist
                        if (saveMetadataBtn) {
                            saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                            saveMetadataBtn.disabled = false;
                        }
                        const saveWithoutFormBtn = document.getElementById('save-photo-without-form');
                        if (saveWithoutFormBtn) {
                            saveWithoutFormBtn.innerHTML = 'Guardar Foto sin Formulario';
                            saveWithoutFormBtn.disabled = false;
                        }
                    }
                } else {
                    console.warn('piexif no est치 disponible.');
                    showStatus('La librer칤a para metadatos no est치 disponible.', 'error');
                }
            } catch (error) {
                console.error('Error al dibujar timestamp en la imagen:', error);
                showStatus('Error al procesar la imagen.', 'error');
                // Reset both buttons if they exist
                if (saveMetadataBtn) {
                    saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                    saveMetadataBtn.disabled = false;
                }
                const saveWithoutFormBtn = document.getElementById('save-photo-without-form');
                if (saveWithoutFormBtn) {
                    saveWithoutFormBtn.innerHTML = 'Guardar Foto sin Formulario';
                    saveWithoutFormBtn.disabled = false;
                }
            }
        }
        
        // Event listener para guardar en galer칤a
        downloadPhotoBtn.addEventListener('click', () => {
            if (!photoWithMetadata) {
                showStatus('No hay imagen para guardar', 'error');
                return;
            }
            saveToGallery(photoWithMetadata);
        });
        
        // Nueva captura
        newCaptureBtn.addEventListener('click', () => {
            resultSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
            startCameraBtn.disabled = false;
            takePhotoBtn.disabled = true;
            
            // Limpiar campos del formulario
            document.getElementById('work-front').value = '';
            document.getElementById('coronation').value = '';
            document.getElementById('observation-type').value = '';
            document.getElementById('activity-performed').value = '';
            
            // Restablecer el texto del bot칩n de guardar en galer칤a si estaba cambiado
            if (downloadPhotoBtn.innerHTML.includes('Guardando...') || 
                downloadPhotoBtn.innerHTML.includes('Guardando en galer칤a') || 
                downloadPhotoBtn.innerHTML.includes('Descargando...')) {
                downloadPhotoBtn.innerHTML = 'Guardar en Galer칤a';
                downloadPhotoBtn.disabled = false;
            }
        });
        
        // Funci칩n para mostrar mensajes de estado
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
        
        // Funci칩n para iniciar la c치mara autom치ticamente al cargar la p치gina
        function autoStartCamera() {
            // Solo iniciar la c치mara si no hay una secuencia activa
            if (!stream) {
                // Simular clic en el bot칩n de iniciar c치mara
                startCameraBtn.click();
            }
        }

        // Verificar soporte de Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con 칠xito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar ServiceWorker:', error);
                    });
            });
        }
        
        // Iniciar c치mara autom치ticamente al cargar la p치gina
        window.addEventListener('load', autoStartCamera);

        // Modal de metadatos
        const viewMetadataBtn = document.getElementById('view-metadata');
        const metadataModal = document.getElementById('metadata-modal');
        const closeButton = document.querySelector('.close-button');
        const metadataDisplay = document.getElementById('metadata-display');

        viewMetadataBtn.addEventListener('click', () => {
            if (photoWithMetadata) {
                const exifObj = piexif.load(photoWithMetadata);
                let metadataText = '';

                // Display User Comment (form data)
                if (exifObj.Exif && exifObj.Exif[piexif.ExifIFD.UserComment]) {
                    try {
                        let userComment;
                        if (piexif.helper && piexif.helper.decodeFromUnicode) {
                            userComment = piexif.helper.decodeFromUnicode(exifObj.Exif[piexif.ExifIFD.UserComment]);
                        } else {
                            // Fallback: if the decodeFromUnicode method is not available,
                            // try to extract the string manually (assuming ASCII\0 prefix was used)
                            const comment = exifObj.Exif[piexif.ExifIFD.UserComment];
                            if (comment.startsWith('ASCII\0')) {
                                userComment = comment.substring(6); // Remove 'ASCII\0' prefix
                            } else {
                                userComment = comment;
                            }
                        }
                        const jsonData = JSON.parse(userComment);
                        metadataText += 'Datos del Formulario:\n';
                        metadataText += JSON.stringify(jsonData, null, 2);
                        metadataText += '\n\n';
                    } catch (e) {
                        console.error('Error parsing user comment:', e);
                        metadataText += 'Datos del Formulario (no se pudo decodificar):\n';
                        metadataText += exifObj.Exif[piexif.ExifIFD.UserComment] + '\n\n';
                    }
                } else {
                    metadataText += 'No se encontraron datos del formulario en los metadatos.\n\n';
                }

                // Display GPS data
                if (exifObj.GPS && Object.keys(exifObj.GPS).length > 0) {
                    metadataText += 'Datos GPS:\n';
                    
                    // Get GPS coordinates
                    let lat = null, lng = null;
                    let latRef = null, lngRef = null;
                    
                    for (const tag in exifObj.GPS) {
                        const tagName = piexif.GPSIFD[tag] || `Unknown Tag (${tag})`;
                        
                        // Process GPS coordinates
                        if (tag == piexif.GPSIFD.GPSLatitude) {
                            const gpsLat = exifObj.GPS[tag];
                            if (Array.isArray(gpsLat) && gpsLat.length === 3) {
                                // Calculate decimal degrees from DMS
                                const deg = gpsLat[0][0] / gpsLat[0][1];
                                const min = gpsLat[1][0] / gpsLat[1][1];
                                const sec = gpsLat[2][0] / gpsLat[2][1];
                                lat = deg + (min / 60) + (sec / 3600);
                            }
                            metadataText += `${tagName}: ${exifObj.GPS[tag]}\n`;
                        } else if (tag == piexif.GPSIFD.GPSLongitude) {
                            const gpsLng = exifObj.GPS[tag];
                            if (Array.isArray(gpsLng) && gpsLng.length === 3) {
                                // Calculate decimal degrees from DMS
                                const deg = gpsLng[0][0] / gpsLng[0][1];
                                const min = gpsLng[1][0] / gpsLng[1][1];
                                const sec = gpsLng[2][0] / gpsLng[2][1];
                                lng = deg + (min / 60) + (sec / 3600);
                            }
                            metadataText += `${tagName}: ${exifObj.GPS[tag]}\n`;
                        } else if (tag == piexif.GPSIFD.GPSLatitudeRef) {
                            latRef = exifObj.GPS[tag];
                            metadataText += `${tagName}: ${exifObj.GPS[tag]}\n`;
                        } else if (tag == piexif.GPSIFD.GPSLongitudeRef) {
                            lngRef = exifObj.GPS[tag];
                            metadataText += `${tagName}: ${exifObj.GPS[tag]}\n`;
                        } else {
                            // For other GPS tags, just display as is
                            metadataText += `${tagName}: ${exifObj.GPS[tag]}\n`;
                        }
                    }
                    
                    // Display calculated coordinates if available
                    if (lat !== null && lng !== null && latRef && lngRef) {
                        const latSign = latRef === 'S' ? -1 : 1;
                        const lngSign = lngRef === 'W' ? -1 : 1;
                        const calculatedLat = (lat * latSign).toFixed(8);
                        const calculatedLng = (lng * lngSign).toFixed(8);
                        metadataText += `\nCoordenadas calculadas:\n`;
                        metadataText += `Latitud: ${calculatedLat}춿\n`;
                        metadataText += `Longitud: ${calculatedLng}춿\n`;
                    }
                } else {
                    metadataText += 'No se encontraron datos GPS en los metadatos.\n';
                }
                
                // Display DateTime
                if (exifObj.Exif && exifObj.Exif[piexif.ExifIFD.DateTimeOriginal]) {
                    metadataText += `\nFecha y Hora Original: ${exifObj.Exif[piexif.ExifIFD.DateTimeOriginal]}\n`;
                } else if (exifObj['0th'] && exifObj['0th'][piexif.ImageIFD.DateTime]) {
                    metadataText += `\nFecha y Hora: ${exifObj['0th'][piexif.ImageIFD.DateTime]}\n`;
                }

                metadataDisplay.textContent = metadataText;
                metadataModal.classList.remove('hidden');
            } else {
                showStatus('No hay foto para ver los metadatos.', 'error');
            }
        });

        closeButton.addEventListener('click', () => {
            metadataModal.classList.add('hidden');
        });

        window.addEventListener('click', (event) => {
            if (event.target == metadataModal) {
                metadataModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>