<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDR-CAM - Aplicaci√≥n de Captura de Fotos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∑</text></svg>">
</head>
<body>
    <div class="container">
        <h1>GDR-CAM - Aplicaci√≥n de Captura de Fotos</h1>
        
        <div id="camera-section">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
            
            <div class="controls">
                <button id="start-camera">Iniciar C√°mara</button>
                <button id="take-photo" disabled>Tomar Foto</button>
            </div>
        </div>
        
        <div id="form-section" class="hidden">
            <h2>Formulario de Observaci√≥n</h2>
            
            <div class="form-group">
                <label for="work-front">Frente de Trabajo:</label>
                <input type="text" id="work-front" required>
            </div>
            
            <div class="form-group">
                <label for="coronation">Coronamiento:</label>
                <input type="text" id="coronation" required>
            </div>
            
            <div class="form-group">
                <label for="observation-type">Tipo de Observaci√≥n:</label>
                <select id="observation-type" required>
                    <option value="">Seleccione una opci√≥n</option>
                    <option value="estructural">Estructural</option>
                    <option value="ambiental">Ambiental</option>
                    <option value="geotecnica">Geot√©cnica</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="activity-performed">Actividad Realizada:</label>
                <textarea id="activity-performed" rows="4" required></textarea>
            </div>
            
            <div class="action-buttons">
                <button id="save-metadata">Guardar Foto con Metadatos</button>
            </div>
        </div>
        
        <div id="result-section" class="result-container hidden">
            <h2>Foto Capturada</h2>
            <img id="photo-preview" src="" alt="Vista previa de la foto">
            <div class="action-buttons">
                <button id="new-capture">Nueva Captura</button>
                <button id="download-photo">Guardar en Galer√≠a</button>
            </div>
        </div>
        
        <div id="status-message" class="status hidden"></div>
    </div>

    <script src="exif.js"></script>
    <script src="piexif.js"></script>
    <script src="save-image.js"></script>
    <script>
        // Variables para elementos del DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const formSection = document.getElementById('form-section');
        const resultSection = document.getElementById('result-section');
        const photoPreview = document.getElementById('photo-preview');
        const saveMetadataBtn = document.getElementById('save-metadata');
        const newCaptureBtn = document.getElementById('new-capture');
        const downloadPhotoBtn = document.getElementById('download-photo');
        const cameraSection = document.getElementById('camera-section');
        const statusMessage = document.getElementById('status-message');
        
        let stream = null;
        let capturedPhotoDataUrl = null;
        let photoWithMetadata = null;
        let currentLocation = null;
        
        // Iniciar c√°mara
        startCameraBtn.addEventListener('click', async () => {
            try {
                // Primero intentar con c√°mara trasera (environment)
                const constraints = { 
                    video: { facingMode: 'environment' } 
                };
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (environmentError) {
                    console.warn('No se pudo acceder a la c√°mara trasera, intentando con c√°mara frontal:', environmentError);
                    // Si falla, intentar con c√°mara frontal
                    const constraintsAlt = { 
                        video: { facingMode: 'user' } 
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraintsAlt);
                }
                
                video.srcObject = stream;
                takePhotoBtn.disabled = false;
                startCameraBtn.disabled = true;
                showStatus('C√°mara iniciada. Puede tomar una foto.', 'success');
                
                // Intentar obtener la ubicaci√≥n
                getCurrentLocation();
            } catch (err) {
                console.error('Error al acceder a la c√°mara:', err);
                showStatus('Error al acceder a la c√°mara. Aseg√∫rese de permitir el acceso.', 'error');
            }
        });
        
        // Intentar obtener la ubicaci√≥n actual
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        console.log('Ubicaci√≥n obtenida:', currentLocation);
                    },
                    (error) => {
                        console.warn('No se pudo obtener la ubicaci√≥n:', error.message);
                        showStatus('No se pudo obtener la ubicaci√≥n del dispositivo', 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                console.warn('Geolocalizaci√≥n no soportada');
                showStatus('La geolocalizaci√≥n no es compatible con este navegador', 'error');
            }
        }
        
        // Tomar foto
        takePhotoBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedPhotoDataUrl = canvas.toDataURL('image/jpeg');
            video.srcObject = null;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Mostrar el formulario
            cameraSection.classList.add('hidden');
            formSection.classList.remove('hidden');
            
            takePhotoBtn.disabled = true;
            startCameraBtn.disabled = false;
        });
        
        // Guardar foto con metadatos
        saveMetadataBtn.addEventListener('click', () => {
            const workFront = document.getElementById('work-front').value;
            const coronation = document.getElementById('coronation').value;
            const observationType = document.getElementById('observation-type').value;
            const activityPerformed = document.getElementById('activity-performed').value;
            
            if (!workFront || !coronation || !observationType || !activityPerformed) {
                showStatus('Por favor complete todos los campos del formulario.', 'error');
                return;
            }
            
            // Crear objeto de metadatos
            const metadata = {
                workFront,
                coronation,
                observationType,
                activityPerformed,
                location: currentLocation,
                timestamp: new Date().toISOString()
            };
            
            // Mostrar indicador de carga
            saveMetadataBtn.innerHTML = '<span class="loading"></span> Procesando...';
            saveMetadataBtn.disabled = true;
            
            // A√±adir los metadatos a la imagen
            addMetadataToImage(capturedPhotoDataUrl, metadata);
        });
        
        // Funci√≥n para a√±adir metadatos a la imagen
        function addMetadataToImage(imageDataUrl, metadata) {
            // Primero intentar con piexif si est√° disponible
            if (typeof piexif !== 'undefined' && piexif.dump) {
                try {
                    // Cargar la imagen existente con piexif
                    let exifObj = piexif.load(imageDataUrl);
                    
                    // Si no hay exif, crear uno vac√≠o
                    if (!exifObj) {
                        exifObj = {
                            "0th": {},
                            "Exif": {},
                            "GPS": {},
                            "Interop": {},
                            "thumbnail": null
                        };
                    }
                    
                    // Agregar los metadatos como un comentario de usuario
                    // Codificar los metadatos como una cadena JSON
                    const userComment = JSON.stringify(metadata);
                    
                    // Guardar en el campo UserComment de los metadatos EXIF
                    exifObj["Exif"][piexif.ExifIFD.UserComment] = userComment;
                    
                    // Si hay datos de ubicaci√≥n, agregarlos a los metadatos GPS
                    if (metadata.location) {
                        const lat = metadata.location.latitude;
                        const lng = metadata.location.longitude;
                        
                        // Convertir a formato GPS EXIF (grados, minutos, segundos)
                        const latRef = lat >= 0 ? "N" : "S";
                        const lngRef = lng >= 0 ? "E" : "W";
                        
                        const absLat = Math.abs(lat);
                        const absLng = Math.abs(lng);
                        
                        const latDeg = Math.floor(absLat);
                        const latMin = Math.floor((absLat - latDeg) * 60);
                        const latSec = Math.floor(((absLat - latDeg) * 60 - latMin) * 60 * 1000) / 1000;
                        
                        const lngDeg = Math.floor(absLng);
                        const lngMin = Math.floor((absLng - lngDeg) * 60);
                        const lngSec = Math.floor(((absLng - lngDeg) * 60 - lngMin) * 60 * 1000) / 1000;
                        
                        exifObj["GPS"] = {
                            [piexif.GPSIFD.GPSVersionID]: [2, 2, 0, 0],
                            [piexif.GPSIFD.GPSLatitudeRef]: latRef,
                            [piexif.GPSIFD.GPSLatitude]: [
                                [latDeg, 1],
                                [latMin, 1],
                                [Math.floor(latSec * 1000), 1000]
                            ],
                            [piexif.GPSIFD.GPSLongitudeRef]: lngRef,
                            [piexif.GPSIFD.GPSLongitude]: [
                                [lngDeg, 1],
                                [lngMin, 1],
                                [Math.floor(lngSec * 1000), 1000]
                            ]
                        };
                    }
                    
                    // Aplicar la fecha actual al campo DateTimeOriginal
                    const now = new Date();
                    const dateTimeOriginal = now.getFullYear() + ":" + 
                        String(now.getMonth() + 1).padStart(2, '0') + ":" + 
                        String(now.getDate()).padStart(2, '0') + " " +
                        String(now.getHours()).padStart(2, '0') + ":" + 
                        String(now.getMinutes()).padStart(2, '0') + ":" + 
                        String(now.getSeconds()).padStart(2, '0');
                    
                    exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = dateTimeOriginal;
                    
                    // Convertir el objeto EXIF a bytes
                    const exifBytes = piexif.dump(exifObj);
                    
                    // Insertar los metadatos en la imagen
                    const newImage = piexif.insert(exifBytes, imageDataUrl);
                    
                    // Guardar la imagen con metadatos
                    photoWithMetadata = newImage;
                    
                    // Mostrar la imagen en el preview
                    photoPreview.src = newImage;
                    
                    // Mostrar secci√≥n de resultados
                    formSection.classList.add('hidden');
                    resultSection.classList.remove('hidden');
                    
                    showStatus('¬°Foto guardada con metadatos!', 'success');
                    
                    // Restablecer el bot√≥n
                    saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                    saveMetadataBtn.disabled = false;
                    
                    // Restablecer tambi√©n el bot√≥n de guardar en galer√≠a si fue afectado
                    if (downloadPhotoBtn.innerHTML.includes('Guardando...') || 
                        downloadPhotoBtn.innerHTML.includes('Guardando en galer√≠a') || 
                        downloadPhotoBtn.innerHTML.includes('Descargando...')) {
                        downloadPhotoBtn.innerHTML = 'Guardar en Galer√≠a';
                        downloadPhotoBtn.disabled = false;
                    }
                    
                    return; // Salir despu√©s de √©xito
                } catch (err) {
                    console.warn('Error con piexif, intentando m√©todo alternativo:', err);
                    // Continuar con m√©todo alternativo
                }
            } else {
                console.warn('piexif no est√° disponible, usando m√©todo alternativo');
            }
            
            // M√©todo alternativo: usar canvas para crear nueva imagen y almacenar los datos en localStorage o usar el comentario
            try {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.drawImage(img, 0, 0);
                    
                    // Guardar datos en formato JSON para referencia
                    const metadataJson = JSON.stringify(metadata);
                    
                    // A√±adir los metadatos a los datos de imagen como comentario
                    canvas.toBlob(function(blob) {
                        // Crear una URL de objeto para la imagen con metadatos
                        const newImageUrl = URL.createObjectURL(blob);
                        photoWithMetadata = newImageUrl;
                        
                        // Mostrar la imagen en el preview
                        photoPreview.src = newImageUrl;
                        
                        // Mostrar secci√≥n de resultados
                        formSection.classList.add('hidden');
                        resultSection.classList.remove('hidden');
                        
                        showStatus('¬°Foto guardada! Metadatos almacenados internamente.', 'success');
                        
                        // Restablecer el bot√≥n
                        saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                        saveMetadataBtn.disabled = false;
                        
                        // Restablecer tambi√©n el bot√≥n de guardar en galer√≠a si fue afectado
                        if (downloadPhotoBtn.innerHTML.includes('Guardando...') || 
                            downloadPhotoBtn.innerHTML.includes('Guardando en galer√≠a') || 
                            downloadPhotoBtn.innerHTML.includes('Descargando...')) {
                            downloadPhotoBtn.innerHTML = 'Guardar en Galer√≠a';
                            downloadPhotoBtn.disabled = false;
                        }
                    }, 'image/jpeg', 0.9);
                };
                img.src = imageDataUrl;
            } catch (err) {
                console.error('Error en m√©todo alternativo:', err);
                showStatus('Error al procesar la imagen: ' + err.message, 'error');
                
                // En caso de error total, usar la imagen original
                photoPreview.src = capturedPhotoDataUrl;
                formSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                showStatus('Foto guardada (sin metadatos)', 'success');
                
                // Restablecer el bot√≥n
                saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                saveMetadataBtn.disabled = false;
                
                // Restablecer tambi√©n el bot√≥n de guardar en galer√≠a si fue afectado
                if (downloadPhotoBtn.innerHTML.includes('Guardando...') || 
                    downloadPhotoBtn.innerHTML.includes('Guardando en galer√≠a') || 
                    downloadPhotoBtn.innerHTML.includes('Descargando...')) {
                    downloadPhotoBtn.innerHTML = 'Guardar en Galer√≠a';
                    downloadPhotoBtn.disabled = false;
                }
            }
        }
        
        // Event listener para guardar en galer√≠a
        downloadPhotoBtn.addEventListener('click', () => {
            if (!photoWithMetadata) {
                showStatus('No hay imagen para guardar', 'error');
                return;
            }
            
            // Determinar si es un dispositivo iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isIOS) {
                // Para dispositivos iOS, mostrar instrucciones
                showStatus('Mant√©n presionada la imagen y selecciona "Guardar imagen" para guardar en la galer√≠a', 'success');
                
                // Abrir la imagen en una nueva ventana para facilitar el guardado
                window.open(photoWithMetadata, '_blank');
            } else {
                // Para otros dispositivos, intentar guardar directamente
                saveToGallery(photoWithMetadata);
            }
        });
        
        // Nueva captura
        newCaptureBtn.addEventListener('click', () => {
            resultSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
            startCameraBtn.disabled = false;
            takePhotoBtn.disabled = true;
            
            // Limpiar campos del formulario
            document.getElementById('work-front').value = '';
            document.getElementById('coronation').value = '';
            document.getElementById('observation-type').value = '';
            document.getElementById('activity-performed').value = '';
            
            // Restablecer el texto del bot√≥n de guardar en galer√≠a si estaba cambiado
            if (downloadPhotoBtn.innerHTML.includes('Guardando...') || 
                downloadPhotoBtn.innerHTML.includes('Guardando en galer√≠a') || 
                downloadPhotoBtn.innerHTML.includes('Descargando...')) {
                downloadPhotoBtn.innerHTML = 'Guardar en Galer√≠a';
                downloadPhotoBtn.disabled = false;
            }
        });
        
        // Funci√≥n para mostrar mensajes de estado
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
        
        // Verificar soporte de Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con √©xito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>